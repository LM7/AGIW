<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>DejaVuMiPiaciTu</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <script src="//code.jquery.com/jquery-1.11.2.js"></script>
    <link href="sfondo.css" rel="stylesheet" type="text/css">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</head>

<body background="">
<img src="dejavu.png" id="imgSearch" style="margin-top:180px; margin-left: 400px; margin-bottom:-30px"/>
<img src="dejavupiccolo.png" id="imgSearchLittle" style="margin-top:-20px; margin-left: 100px; display:none"/>
    <form  name="f1" onsubmit='select(); return false;'>
  <div id="mydiv" class="row">
        <div   class="input-group" style="margin-right:400px; margin-left: 400px; margin-top: 30px">
            <input id="barraRic" name="query" type="text" class="form-control" placeholder="Search">
            <span class="input-group-btn">
                <button id="button" class="btn btn-default" type="submit">GO</button>
            </span>
        </div>
    </div>
    </div>
  
<div id="result"></div>
<!--<pre>RISULTATI<div id="raw"></div></pre>-->
</form>
    
    <script>
    function select() {
    	alert('inizio');
    	//var str_jsonSpell = 
    	xmlhttpPost_select("/collection1/select");
    	//xmlhttpPost_spell("/collection1/spell");
    	//updatepage(str_jsonSpell);
    }
    
    function xmlhttpPost_select(strURL) {
        //alert("xml");
        var xmlHttpReq = false;
        var self = this;
        if (window.XMLHttpRequest) { // Mozilla/Safari
            self.xmlHttpReq = new XMLHttpRequest(); 
        }
        else if (window.ActiveXObject) { // IE
            self.xmlHttpReq = new ActiveXObject("Microsoft.XMLHTTP");
        }
        self.xmlHttpReq.open('POST', strURL, true);
        self.xmlHttpReq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        self.xmlHttpReq.onreadystatechange = function() {
            if (self.xmlHttpReq.readyState == 4) {
                select_ok(self.xmlHttpReq.responseText); // qui
            }
        }  

        var params = getstandardargs_select().concat(getquerystring());
        var strData = params.join('&');
        self.xmlHttpReq.send(strData);
    }
    
    function select_ok(str_json_select){
    	//updatepage(str_json_select);
    	xmlhttpPost_spell("/collection1/spell",str_json_select);
    }
    
    function xmlhttpPost_spell(strURL,str_json_select) {
        alert("xml");
        var xmlHttpReq = false;
        var self = this;
        if (window.XMLHttpRequest) { // Mozilla/Safari
            self.xmlHttpReq = new XMLHttpRequest(); 
        }
        else if (window.ActiveXObject) { // IE
            self.xmlHttpReq = new ActiveXObject("Microsoft.XMLHTTP");
        }
        self.xmlHttpReq.open('POST', strURL, true);
        self.xmlHttpReq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        self.xmlHttpReq.onreadystatechange = function() {
            if (self.xmlHttpReq.readyState == 4) {
                select_spell_ok(self.xmlHttpReq.responseText,str_json_select); // qui
            }
        }  

        var params = getstandardargs_spell().concat(getquerystring());
        var strData = params.join('&');
        self.xmlHttpReq.send(strData);
    }
    
    function select_spell_ok(str_json_spell,str_json_select){
    	var json = JSON.parse(str_json_spell);
        alert("aa");
        q="";
        if (json.spellcheck.suggestions!=null) { 
            i=0;
            while (json.spellcheck.suggestions[i]!=null) {
            	i++;
                q += json.spellcheck.suggestions[i].suggestion[0] + ' ';
                i++;
              }
        }
        alert('a');
        xmlhttpPost_ReSelect("/collection1/select",q,str_json_select)
        
    }
    
    function xmlhttpPost_ReSelect(strURL,q,str_json_select_old) {
        //alert("xml");
        var xmlHttpReq = false;
        var self = this;
        if (window.XMLHttpRequest) { // Mozilla/Safari
            self.xmlHttpReq = new XMLHttpRequest(); 
        }
        else if (window.ActiveXObject) { // IE
            self.xmlHttpReq = new ActiveXObject("Microsoft.XMLHTTP");
        }
        self.xmlHttpReq.open('POST', strURL, true);
        self.xmlHttpReq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        self.xmlHttpReq.onreadystatechange = function() {
            if (self.xmlHttpReq.readyState == 4) {
                confronta(str_json_select_old,self.xmlHttpReq.responseText); // qui
            }
        }  

        var params = getstandardargs_select().concat('q='+q);
        var strData = params.join('&');
        self.xmlHttpReq.send(strData);
    }
    
    function confronta(str_json_select_old,str_json_select_new) {
    	var json_old = JSON.parse(str_json_select_old);
        var numFound_old = json_old.response.numFound;
        var json_new = JSON.parse(str_json_select_new);
        var numFound_new = json_new.response.numFound;
        alert('old'+numFound_old);
        alert('new'+numFound_new);
        if(numFound_old>=numFound_new) {
        	alert('vecchi')
        	updatepage(str_json_select_old);
        }
        else {
        	alert('nuovi');
        	updatepage(str_json_select_new);
        }
    }

    function getstandardargs_select() {
        //alert("getStand");
        var params = [
            'wt=json'
            , 'indent=on'
            , 'hl=true'
            , 'hl.fl=name,features'
            ];
        
        return params;
    }

    function getstandardargs_spell() {
        //alert("getStand");
        var params = [
            'wt=json'
            , 'indent=on'
            , 'spellcheck=true'];
        
        return params;
    }
    
    function getquerystring() {
        var form = document.forms['f1'];
        var query = form.query.value;
        qstr = 'q=' + escape(query);
        //alert("getquery");
        return qstr;
    }

    // this function does all the work of parsing the solr response and updating the page.
    function updatepage(str){
        //alert(str);
        var json = JSON.parse(str);
        //document.getElementById("raw").innerHTML = str; STAMPA I RISULTATI DI SOLR
        var rsp = eval("("+str+")"); // use eval to parse Solr's JSON response
        var stampata= '<br> <h4 style="color:#1E90FF;margin-top:-20px; margin-bottom:40px"> &nbsp &nbsp Circa ' + rsp.response.numFound +' risultati </h4>'; //QUI SE NUMFOUND > 1
        
        //GESTIONE DEL RISULTATO
        var numeroRisultati = rsp.response.numFound;
        if (numeroRisultati > 0) { //name-> titolo; price-> sito; price_c->body
            stampata += "<ul>";
            for (i = 0; i < numeroRisultati; i++) {
                stampata += '<li> <h4  style="color:#0000FF; margin-bottom:-10px;"> <strong>' + json.response.docs[i].title +'</strong> </h4> </li>';
                stampata += '<h6 style="color:#228B22; margin-bottom:-5px;"> <ins> <a style="color:#228B22;" href='+ json.response.docs[i].url +'>'+json.response.docs[i].url+'</a> </ins> </h6> ';
                stampata += ' <h5 style="color:#000000; margin-bottom:20px;">'+ json.response.docs[i].body +'</h5> ';
                
            }
            stampata += "</ul>";
        }
        else {
            stampata += ' <h1 style="color:#FF0000"> &nbsp  NESSUN RISULTATO </h1>';
        }
        
        /*Stampa altri dati prima dei risultati
        var first = rsp.response.docs[0]; 
        html += "<br>product name="+ first.name;
        var hl=rsp.highlighting[first.id];
        if (hl.name != null) { 
            html += "<br>name highlighted: " + hl.name[0]; 
        }
        if (hl.features != null) { 
            html += "<br>features highligted: " + hl.features[0]; 
        }*/
       
        document.getElementById("result").innerHTML = stampata;
        //document.getElementById("result").innerHTML = html + stampata;
        //alert("DentroUpdate");
        event.preventDefault();
        var imgPrincipal = document.getElementById('imgSearch');
        $(imgPrincipal).hide();
        event.preventDefault();
        var imgLittle = document.getElementById('imgSearchLittle');
        $(imgLittle).show();
        
        
    }
    </script>

</body>
</html>